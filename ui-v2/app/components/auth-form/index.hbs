<StateChart @src={{this.chart}} as |State Guard Action dispatch state|>
  {{yield (hash
    reset=(action dispatch "RESET")
    focus=(action 'focus')
  )}}
  <Guard @name="hasValue" @cond={{action 'hasValue'}} />
  {{!FIXME: Call this reset or similar }}
  <Action @name="clearError" @exec={{queue (action (mut this.error) undefined) (action (mut this.secret) undefined)}} />
  <div class="auth-form" ...attributes>
    <State @matches="error">
      {{#if this.error.status}}
        <p role="alert" class="notice error">
          {{#if this.value.Name}}
            {{#if (eq this.error.status '403')}}
              <strong>Consul login failed</strong><br />
              We received a token from your OIDC provider but could not log in to Consul with it.
            {{else if (eq this.error.status '401')}}
              <strong>Could not log in to provider</strong><br />
              The OIDC provider has rejected this access token. Please have an administrator check your auth method configuration.
            {{else if (eq this.error.status '499')}}
              <strong>SSO log in window closed</strong><br />
              The OIDC provider window was closed. Please try again.
            {{else}}
              <strong>Error</strong><br />
              {{this.error.detail}}
            {{/if}}
          {{else}}
            {{#if (eq this.error.status '403')}}
              <strong>Invalid token</strong><br />
              The token entered does not exist. Please enter a valid token to log in.
            {{else}}
              <strong>Error</strong><br />
              {{this.error.detail}}
            {{/if}}
          {{/if}}
        </p>
      {{/if}}
    </State>
    <form onsubmit={{action dispatch "SUBMIT"}}>
      <fieldset>
        <label class={{concat "type-password" (if (and (state-matches state 'error') (not this.error.status)) ' has-error' '')}}>
          <span>Log in with a token</span>
          <input
            {{ref this 'input'}}
            disabled={{state-matches state "loading"}}
            type={{this.inputType}}
            name="auth[SecretID]"
            placeholder="SecretID"
            value={{this.secret}}
            oninput={{queue
              (action (mut this.secret) value="target.value")
              (action (mut this.value) value="target.value")
              (action dispatch "TYPING")
            }}
          />
          <State @matches="error">
            {{#if (not this.error.status)}}
              <strong role="alert">
                Please enter your secret
              </strong>
            {{/if}}
          </State>
        </label>
      </fieldset>
      <button type="submit" disabled={{state-matches state "loading"}}>
        Log in
      </button>
      <em>Contact your administrator for login credentials.</em>
    </form>
{{#if (env 'CONSUL_SSO_ENABLED')}}
    <DataSource
      @src={{concat '/' (or this.nspace 'default') '/' this.dc '/oidc/providers'}}
      @onchange={{queue (action (mut this.providers) value="data")}}
      @onerror={{queue (action (mut this.error) value="error.errors.firstObject")}}
      @loading="lazy"
    />
  {{#if (gt this.providers.length 0)}}
    <p>
      <span>or</span>
    </p>
  {{/if}}
  <OidcSelect
    @items={{this.providers}}
    @disabled={{state-matches state "loading"}}
    @onchange={{queue (action (mut this.value)) (action dispatch "SUBMIT") }}
    @onerror={{queue (action (mut this.error) value="error.errors.firstObject") (action dispatch "ERROR")}}
  />
{{/if}}
  </div>
  <State @matches="loading">
    <TokenSource
      @dc={{this.dc}}
      @nspace={{or this.value.Namespace this.nspace}}
      @type={{if this.value.Name 'oidc' 'secret'}}
      @value={{if this.value.Name this.value.Name this.value}}
      @onchange={{queue (action dispatch "RESET") (action this.onsubmit)}}
      @onerror={{queue (action (mut this.error) value="error.errors.firstObject") (action dispatch "ERROR")}}
    />
  </State>
</StateChart>